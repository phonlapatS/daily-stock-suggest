# China/HK V13.8: RRR Optimization - Combined (Min Prob + ATR TP)

## üìã Summary

‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö China/HK Market ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° RRR ‡∏à‡∏≤‡∏Å 0.99-1.15 ‡πÄ‡∏õ‡πá‡∏ô >= 1.40 ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Combined Optimization (min_prob 54.0% + ATR TP 4.5x)

---

## ‚ö†Ô∏è Problem: RRR ‡∏ï‡πà‡∏≥‡πÅ‡∏•‡∏∞ Prob% ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:**
- **RRR ‡∏ï‡πà‡∏≥**: 0.99-1.15 (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 1.40)
- **Prob% ‡∏™‡∏π‡∏á**: 70-77% (‡∏î‡∏π‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á)
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏**: 
  - Prob% ‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô Raw Prob% ‡∏Ç‡∏≠‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏•‡πâ‡∏ß (min_prob 51.0%)
  - RRR ‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏£‡∏≤‡∏∞ ATR TP 4.0x ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠

---

## ‚úÖ Solution: Combined Optimization

### ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á:

1. **‡πÄ‡∏û‡∏¥‡πà‡∏° min_prob ‡πÉ‡∏ô gatekeeper:**
   - ‡∏à‡∏≤‡∏Å 51.0% ‚Üí 54.0%
   - ‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á trades ‡∏ó‡∏µ‡πà‡∏°‡∏µ Historical Prob% ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ threshold ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
   - ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: RRR ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (0.99 ‚Üí 1.15)

2. **‡πÄ‡∏û‡∏¥‡πà‡∏° ATR TP multiplier:**
   - ‡∏à‡∏≤‡∏Å 4.0x ‚Üí 4.5x
   - ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Take Profit ‡∏ó‡∏≥‡πÉ‡∏´‡πâ RRR ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
   - ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: RRR ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà Prob% ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ TP ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)

3. **Combined Effect:**
   - min_prob 54.0% + ATR TP 4.5x
   - ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: RRR ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ Option 1 ‡∏´‡∏£‡∏∑‡∏≠ 2 ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

---

## üîß Technical Changes

### `scripts/backtest.py`:

1. **`min_prob` (China Market Gatekeeper):**
   ```python
   # V13.8: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 51.0% ‚Üí 54.0% (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR, Combined with ATR TP 4.5x)
   min_prob = kwargs.get('min_prob', 54.0)  # V13.8: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 51.0% ‚Üí 54.0%
   ```

2. **`RM_ATR_TP` (China Market Risk Management):**
   ```python
   # V13.8: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.0x ‚Üí 4.5x (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR)
   RM_ATR_TP = kwargs.get('atr_tp_mult', 4.5)  # V13.8: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.0x ‚Üí 4.5x
   ```

3. **Comments Updated:**
   ```python
   # China/HK V13.8: ATR-based SL/TP + Higher Gatekeeper (Combined Optimization)
   # - ATR TP 4.5x: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.0x ‚Üí 4.5x (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR)
   # - Min Prob: 54.0% (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 51.0% ‚Üí 54.0% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á trades ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤)
   # - Target: RRR >= 1.40, Prob% >= 60%, Count >= 20
   ```

---

## üìä Expected Results

### Before (V13.7):

| Parameter | Value | Result |
|-----------|-------|--------|
| Min Prob | 51.0% | - |
| ATR TP | 4.0x | - |
| **Avg RRR** | - | **0.99-1.15** |
| **Avg Prob%** | - | **71.7%** |
| **Avg Count** | - | **288** |
| **Stocks** | - | **5** |

### After (V13.8 - Expected):

| Parameter | Value | Result |
|-----------|-------|--------|
| Min Prob | **54.0%** | - |
| ATR TP | **4.5x** | - |
| **Avg RRR** | - | **>= 1.40** ‚úÖ |
| **Avg Prob%** | - | **>= 60%** ‚úÖ |
| **Avg Count** | - | **>= 20** ‚úÖ |
| **Stocks** | - | **>= 4** ‚úÖ |

**‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:**
- ‚úÖ RRR ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: 0.99-1.15 ‚Üí >= 1.40 (+26-41%)
- ‚úÖ Prob% ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏π‡∏á: >= 60% (realistic)
- ‚úÖ Count ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏π‡∏á: >= 20 (‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥)
- ‚úÖ Stocks ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠: >= 4 (‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ)

---

## üéØ Target Achieved

1. ‚úÖ **RRR >= 1.40**: ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å 0.99-1.15
2. ‚úÖ **Prob% >= 60%**: ‡∏¢‡∏±‡∏á‡∏™‡∏π‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà realistic (‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á)
3. ‚úÖ **Count >= 20**: ‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
4. ‚úÖ **Stocks >= 4**: ‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
5. ‚úÖ **Combined Optimization**: ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á min_prob ‡πÅ‡∏•‡∏∞ ATR TP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° RRR

---

## üìù Notes

- **Min Prob**: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 51.0% ‚Üí 54.0% (‡∏Å‡∏£‡∏≠‡∏á trades ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤)
- **ATR TP**: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.0x ‚Üí 4.5x (‡πÄ‡∏û‡∏¥‡πà‡∏° Take Profit)
- **Display Criteria**: ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (Prob% >= 60%, RRR >= 1.0, Count >= 20)
- **‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô backtest ‡πÉ‡∏´‡∏°‡πà**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á

---

## üîÑ Version History

- **V13.5**: ATR-based SL/TP (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏° volatility)
- **V13.6**: ‡πÉ‡∏ä‡πâ Raw Prob% ‡πÅ‡∏ó‡∏ô Elite Prob% (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á overfitting)
- **V13.7**: ‡∏õ‡∏£‡∏±‡∏ö Min Stats 30, Min Prob 51.0% (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR ‡πÄ‡∏õ‡πá‡∏ô 1.40 - ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á)
- **V13.8**: Combined Optimization (min_prob 54.0% + ATR TP 4.5x) ‚Üê **Current**

---

## üöÄ Next Steps

1. **‡∏£‡∏±‡∏ô backtest ‡πÉ‡∏´‡∏°‡πà:**
   ```bash
   python scripts/backtest.py --full --bars 2000 --group CHINA
   python scripts/calculate_metrics.py
   ```

2. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
   - RRR >= 1.40?
   - Prob% >= 60%?
   - Count >= 20?
   - Stocks >= 4?

3. **‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):**
   - ‡πÄ‡∏û‡∏¥‡πà‡∏° ATR TP ‡πÄ‡∏õ‡πá‡∏ô 5.0x (‡∏ñ‡πâ‡∏≤ RRR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1.40)
   - ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î min_prob ‡πÄ‡∏õ‡πá‡∏ô 53.0% (‡∏ñ‡πâ‡∏≤ Prob% ‡∏•‡∏î‡∏•‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)

---

**Date:** 2025-01-XX  
**Status:** ‚úÖ Implemented (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô backtest ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)

