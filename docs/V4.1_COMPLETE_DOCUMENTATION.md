# üìò ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö V4.1 (Complete Documentation)

> **‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô**: 4.1  
> **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà**: 2026-02-14  
> **Codename**: "Production-Ready Risk Management System"  
> **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞**: ‚úÖ Production-Ready  
> **Repository**: [https://github.com/phonlapatS/daily-stock-suggest](https://github.com/phonlapatS/daily-stock-suggest)

---

## üìë ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç

1. [Executive Summary](#1-executive-summary)
2. [System Architecture](#2-system-architecture)
3. [Market-Specific Settings](#3-market-specific-settings)
4. [Intraday Metals (15min/30min)](#4-intraday-metals-15min30min)
5. [Risk Management](#5-risk-management)
6. [Display Criteria](#6-display-criteria)
7. [Technical Implementation](#7-technical-implementation)
8. [Version History](#8-version-history)

---

## 1. Executive Summary

**Fractal N+1 Prediction System V4.1** ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡πÅ‡∏ö‡∏ö Statistical Pattern Matching ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (Production-Ready) ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô:

1. **Pure Statistics Approach**: ‡πÉ‡∏ä‡πâ Pattern Matching + History Statistics (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Indicator)
2. **Comprehensive Risk Management**: Stop Loss, Take Profit, Trailing Stop, Position Sizing
3. **Production Mode**: Slippage, Commission, Gap Risk, Liquidity Filter
4. **Multi-Market Support**: Thai, US, China/HK, Taiwan, Metals (Daily + Intraday)
5. **Transparent Display**: Count ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î, ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Prob%

### üîë Philosophy Shift

**V6.0 (Indicator-based):**
- ‡πÉ‡∏ä‡πâ ADX, SMA50, Volume Ratio ‡πÄ‡∏õ‡πá‡∏ô filter
- Risk Management: ‡∏°‡∏µ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏ô‡πâ‡∏ô

**V4.1 (Risk Management-based):**
- ‡πÉ‡∏ä‡πâ Pattern Matching + History Statistics
- Risk Management: ‡πÄ‡∏ô‡πâ‡∏ô‡∏°‡∏≤‡∏Å (Stop Loss, Take Profit, Trailing Stop, Position Sizing)
- Production Mode: Slippage, Commission, Gap Risk

---

## 2. System Architecture

### 2.1 Core Components

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Data Layer                            ‚îÇ
‚îÇ  - TradingView API (tvDatafeed)                         ‚îÇ
‚îÇ  - Data Cache (core/data_cache.py)                      ‚îÇ
‚îÇ  - Smart Cache System (99% API reduction)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Pattern Matching                       ‚îÇ
‚îÇ  - Dynamic Pattern Detection (3-8 days)                  ‚îÇ
‚îÇ  - Market-Specific Thresholds                           ‚îÇ
‚îÇ  - History Statistics Calculation                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Gatekeeper Filter                      ‚îÇ
‚îÇ  - Market-Specific min_prob                             ‚îÇ
‚îÇ  - Expectancy > 0                                       ‚îÇ
‚îÇ  - Quality Filters (US: AvgWin > AvgLoss)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Risk Management System                      ‚îÇ
‚îÇ  - Stop Loss (ATR-based or Fixed)                       ‚îÇ
‚îÇ  - Take Profit (ATR-based or Fixed)                     ‚îÇ
‚îÇ  - Trailing Stop (Activate + Distance)                  ‚îÇ
‚îÇ  - Max Hold (Days or Bars)                              ‚îÇ
‚îÇ  - Production Mode (Slippage, Commission, Gap Risk)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Metrics Calculation                    ‚îÇ
‚îÇ  - calculate_metrics.py                                 ‚îÇ
‚îÇ  - Market-Specific Display Criteria                     ‚îÇ
‚îÇ  - Statistical Reliability Analysis                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 Data Flow

1. **Data Fetching**: `get_data_with_cache()` ‚Üí Check cache ‚Üí Fetch delta (50 bars) or full (5000 bars)
2. **Pattern Detection**: Scan 3-8 day patterns ‚Üí Match with history ‚Üí Calculate statistics
3. **Gatekeeper**: Filter by min_prob and expectancy ‚Üí Save to `trade_history_*.csv`
4. **Risk Management**: Simulate trades with RM ‚Üí Calculate actual returns
5. **Metrics**: Aggregate by symbol ‚Üí Apply display criteria ‚Üí Display tables

---

## 3. Market-Specific Settings

### 3.1 Daily Markets

| Market | Strategy | Threshold | Floor | Min Stats | Gatekeeper | Display Criteria |
|--------|----------|-----------|-------|-----------|------------|------------------|
| **THAI** | MEAN_REVERSION | 1.0x SD | 0.7% | 25 | Prob >= 53% | Prob >= 60% \| RRR >= 1.3 \| Count >= 30 |
| **US** | US_HYBRID_VOL | 0.9x SD | 0.6% | 20 | Prob >= 52% | Prob >= 60% \| RRR >= 1.5 \| Count >= 15 |
| **CHINA/HK** | MEAN_REVERSION | 0.9x SD | 0.5% | 30 | Prob >= 54% | Prob >= 60% \| RRR >= 1.2 \| Count >= 15 |
| **TAIWAN** | REGIME_AWARE | 0.9x SD | 0.5% | 25 | Prob >= 51% | Prob >= 50% \| RRR >= 1.0 \| Count >= 15 |

### 3.2 Strategy Logic

**MEAN_REVERSION:**
- Fade the move (‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô, ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á)
- Pattern `+` ‚Üí SHORT (intended_dir = -1)
- Pattern `-` ‚Üí LONG (intended_dir = 1)

**TREND_FOLLOWING / US_HYBRID_VOL:**
- Follow momentum (‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô, ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á)
- Pattern `+` ‚Üí LONG (intended_dir = 1)
- Pattern `-` ‚Üí SHORT (intended_dir = -1)

**REGIME_AWARE (Taiwan):**
- BULL Market (Price > SMA50 > SMA200) ‚Üí TREND
- BEAR/SIDEWAYS Market ‚Üí REVERSION

---

## 4. Intraday Metals (15min/30min)

### 4.1 Overview

‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Metals (Gold & Silver) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö intraday trading ‡πÉ‡∏ô 2 timeframes:
- **30min**: 48 bars/day, 336 bars/week
- **15min**: 96 bars/day, 672 bars/week

### 4.2 Configuration

#### Gold (XAUUSD)

**30min:**
- `fixed_threshold`: 0.60%
- `engine`: TREND_FOLLOWING (Breakout Logic)
- `min_prob`: 58%
- `min_stats`: 35
- `RM_ATR_TP`: 3.5
- `RM_MAX_HOLD`: 48 bars (1 ‡∏ß‡∏±‡∏ô)

**15min:**
- `fixed_threshold`: 0.25%
- `engine`: TREND_FOLLOWING (Breakout Logic)
- `min_prob`: 50%
- `min_stats`: 32
- `RM_ATR_TP`: 4.5 (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR)
- `RM_MAX_HOLD`: 96 bars (1 ‡∏ß‡∏±‡∏ô)

#### Silver (XAGUSD)

**30min:**
- `fixed_threshold`: 0.25%
- `engine`: MEAN_REVERSION (Fakeout Logic)
- `min_prob`: 58%
- `min_stats`: 35
- `RM_ATR_TP`: 3.5
- `RM_MAX_HOLD`: 48 bars (1 ‡∏ß‡∏±‡∏ô)

**15min:**
- `fixed_threshold`: 0.60%
- `engine`: MEAN_REVERSION (Fakeout Logic)
- `min_prob`: 60%
- `min_stats`: 40
- `RM_ATR_TP`: 3.5
- `RM_MAX_HOLD`: 96 bars (1 ‡∏ß‡∏±‡∏ô)

### 4.3 Logic Separation

**Rolling Windows (SD Calculation):**
- **15min**: `short_window=96`, `long_window=672` (1 ‡∏ß‡∏±‡∏ô = 96 bars, 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå = 672 bars)
- **30min**: `short_window=48`, `long_window=336` (1 ‡∏ß‡∏±‡∏ô = 48 bars, 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå = 336 bars)

**Max Hold:**
- **15min**: 96 bars (1 ‡∏ß‡∏±‡∏ô)
- **30min**: 48 bars (1 ‡∏ß‡∏±‡∏ô)

**Min Stats & Min Prob:**
- **Gold 15min**: `min_stats=32`, `min_prob=50%`
- **Silver 15min**: `min_stats=40`, `min_prob=60%`
- **30min**: `min_stats=35`, `min_prob=58%`

### 4.4 Strategy Rationale

**Gold (TREND_FOLLOWING):**
- Breakout Logic ‡∏ï‡∏≤‡∏° Session
- Flow ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏•‡∏≤‡∏î
- ‡∏ï‡∏≤‡∏° momentum ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ breakout

**Silver (MEAN_REVERSION):**
- Mean Reversion/Fakeout Logic
- High Volatility, False Break ‡∏ö‡πà‡∏≠‡∏¢
- ‡∏™‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÅ‡∏£‡∏á

### 4.5 Display Criteria

**METALS (30min):**
- Prob >= 40%
- RRR >= 0.75
- Count >= 20

**METALS (15min):**
- Prob >= 25%
- RRR >= 0.8
- Count >= 20

---

## 5. Risk Management

### 5.1 Market-Specific RM Parameters

| Market | SL Type | SL Value | TP Type | TP Value | RRR Theoretical | Max Hold | Trailing |
|--------|---------|----------|---------|----------|-----------------|----------|----------|
| **THAI** | ATR-based | 1.0x ATR | ATR-based | 3.5x ATR | 3.5 | 5 days | Activate 1.5%, Distance 50% |
| **US** | ATR-based | 1.0x ATR | ATR-based | 3.5x ATR | 3.5 | 5 days | Activate 1.5%, Distance 50% |
| **CHINA/HK** | ATR-based | 1.0x ATR | ATR-based | 3.5x ATR | 3.5 | 5 days | Activate 1.5%, Distance 50% |
| **TAIWAN** | ATR-based | 1.0x ATR | ATR-based | 3.5x ATR | 3.5 | 5 days | Activate 1.5%, Distance 50% |
| **METALS (Daily)** | Fixed | 1.5% | Fixed | 3.5% | 2.33 | 5 days | Activate 1.5%, Distance 50% |
| **METALS (Intraday)** | ATR-based | 1.0x ATR | ATR-based | 3.5-4.5x ATR | 3.5-4.5 | 48-96 bars | Activate 1.5%, Distance 50% |

### 5.2 Production Mode

**Entry Logic:**
- **Backtest Mode**: Enter at current close (ideal)
- **Production Mode**: Enter at next bar's OPEN (realistic)

**Friction Factors:**
- **Slippage**: Market-specific (Thai: 0.1%, US: 0.05%)
- **Commission**: Market-specific (Thai: 0.15%, US: 0.1%)
- **Gap Risk**: Stop Loss can be worse due to gap (Factor: 1.0-1.3x)

**Liquidity Filter:**
- Skip low-volume days in production mode
- Market-specific minimum volume thresholds

---

## 6. Display Criteria

### 6.1 Market-Specific Criteria

| Market | Prob% | RRR | Count | Rationale |
|--------|-------|-----|-------|-----------|
| **THAI** | >= 60% | >= 1.3 | >= 30 | High frequency + High accuracy (Central Limit Theorem) |
| **US** | >= 60% | >= 1.5 | >= 15 | Quality over quantity |
| **CHINA/HK** | >= 60% | >= 1.2 | >= 15 | Quality over quantity |
| **TAIWAN** | >= 50% | >= 1.0 | >= 15 | Realistic criteria for Taiwan market |
| **METALS (30min)** | >= 40% | >= 0.75 | >= 20 | Intraday has more noise |
| **METALS (15min)** | >= 25% | >= 0.8 | >= 20 | 15min has more noise than 30min |

### 6.2 Statistical Reliability

**THAI: Count >= 30**
- ‚úÖ Passes Central Limit Theorem (n >= 30)
- ‚úÖ Margin of Error: ~6.5-10.9% (95% CI)
- ‚úÖ Statistically reliable

**US/CHINA/TAIWAN: Count >= 15**
- ‚ö†Ô∏è Below 30 but acceptable
- ‚ö†Ô∏è Margin of Error: Higher than THAI
- üí° Consider increasing to 20-25 for better reliability

**METALS: Count >= 20**
- ‚ö†Ô∏è Below 30 but acceptable for intraday
- ‚ö†Ô∏è Margin of Error: Higher than daily
- üí° Intraday has more noise, lower Count is acceptable

---

## 7. Technical Implementation

### 7.1 Key Files

**Core Logic:**
- `scripts/backtest.py`: Main backtest engine with RM
- `scripts/calculate_metrics.py`: Metrics calculation and display
- `config.py`: Asset groups and configuration

**Intraday Metals:**
- `scripts/backtest_metals_15m.py`: Gold/Silver 15min backtest
- `scripts/backtest_metals_30m.py`: Gold/Silver 30min backtest

**Data Management:**
- `core/data_cache.py`: Smart cache system
- `core/data_fetcher.py`: TradingView API wrapper

### 7.2 Important Code Sections

**Logic Separation (15min vs 30min):**
```python
# Rolling Windows
if is_intraday:
    is_15min = kwargs.get('interval') == Interval.in_15_minute
    if is_15min:
        short_window = 96   # 1 ‡∏ß‡∏±‡∏ô (24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á / 15 ‡∏ô‡∏≤‡∏ó‡∏µ)
        long_window = 672   # 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (7 ‡∏ß‡∏±‡∏ô * 96 bars/day)
    else:
        short_window = 48   # 1 ‡∏ß‡∏±‡∏ô (24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á / 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
        long_window = 336   # 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (7 ‡∏ß‡∏±‡∏ô * 48 bars/day)

# Max Hold
if is_intraday:
    is_15min = kwargs.get('interval') == Interval.in_15_minute
    if is_15min:
        RM_MAX_HOLD = 96  # 1 ‡∏ß‡∏±‡∏ô
    else:
        RM_MAX_HOLD = 48  # 1 ‡∏ß‡∏±‡∏ô

# Min Stats & Min Prob
if is_intraday:
    is_15min = kwargs.get('interval') == Interval.in_15_minute
    if is_15min:
        is_silver_15m = any(x in symbol.upper() for x in ['XAGUSD', 'SILVER'])
        if is_silver_15m:
            min_stats = 40
            min_prob = 60.0
        else:
            min_stats = 32
            min_prob = 50.0
    else:
        min_stats = 35
        min_prob = 58.0
```

**Strategy Logic:**
```python
if is_intraday:
    engine = kwargs.get('engine', 'MEAN_REVERSION')
    if engine == "TREND_FOLLOWING":
        # Gold: Breakout Logic
        if last_directional == '+': intended_dir = 1
        elif last_directional == '-': intended_dir = -1
    else:
        # Silver: Mean Reversion/Fakeout
        if last_directional == '+': intended_dir = -1
        elif last_directional == '-': intended_dir = 1
```

### 7.3 Trade Log Management

**Overwrite Mode (Metals 15min/30min):**
- `trade_history_METALS_15M.csv`: Overwrite mode (prevent duplicate data)
- `trade_history_METALS.csv`: Overwrite mode (prevent duplicate data)

**Append Mode (Other Markets):**
- `trade_history_THAI.csv`: Append mode (accumulate all trades)
- `trade_history_US.csv`: Append mode (accumulate all trades)
- `trade_history_CHINA.csv`: Append mode (accumulate all trades)
- `trade_history_TAIWAN.csv`: Append mode (accumulate all trades)

---

## 8. Version History

### 8.1 Major Versions

| Version | Codename | Date | Key Features | Status |
|---------|----------|------|--------------|--------|
| V6.0 | Indicator-based | 2026-02 | ADX, SMA50, Volume Ratio filters | ‚ùå Deprecated |
| V6.1 | Simplified | 2026-02 | Removed Indicator filters | ‚ö†Ô∏è Transition |
| V10.0 | Balanced Markets | 2026-02 | Market-specific parameters, Trailing Stop | ‚úÖ Stable |
| V10.1 | All Markets Balanced | 2026-02 | Thai aligned with international | ‚úÖ Stable |
| **V4.1** | **Production-Ready** | **2026-02-14** | **Production Mode, Enhanced RM, Intraday Metals** | **‚úÖ Current** |

### 8.2 V4.1 Key Changes

**Intraday Metals Support:**
- ‚úÖ Added 15min and 30min timeframe support
- ‚úÖ Separated logic for 15min and 30min (rolling windows, max_hold)
- ‚úÖ Strategy differentiation (Gold: TREND_FOLLOWING, Silver: MEAN_REVERSION)
- ‚úÖ Market-specific parameters (min_prob, min_stats, fixed_threshold)

**Logic Separation:**
- ‚úÖ 15min and 30min use different rolling windows
- ‚úÖ 15min and 30min use different max_hold (bars)
- ‚úÖ Gold and Silver 15min use different min_prob and min_stats

**Bug Fixes:**
- ‚úÖ Fixed debug print duplication (min_prob set in loop)
- ‚úÖ Fixed indentation errors
- ‚úÖ Fixed trade log overwrite/append logic

**Display Criteria:**
- ‚úÖ Separate criteria for 15min and 30min
- ‚úÖ Adjusted criteria to show both Gold and Silver

---

## üìö Related Documentation

- **[VERSION_HISTORY.md](VERSION_HISTORY.md)** - Complete version history
- **[V4.1_UPDATE_LOG.md](V4.1_UPDATE_LOG.md)** - Detailed update log
- **[PROJECT_MASTER_MANUAL.md](PROJECT_MASTER_MANUAL.md)** - Main manual
- **[STRATEGY_TABLE_BY_COUNTRY.md](STRATEGY_TABLE_BY_COUNTRY.md)** - Strategy details
- **[COUNTRY_SETTINGS_DETAILED_TABLE.md](COUNTRY_SETTINGS_DETAILED_TABLE.md)** - Settings table

---

**Last Updated:** 2026-02-14  
**Version:** 4.1  
**Status:** ‚úÖ Production-Ready  
**Repository:** [https://github.com/phonlapatS/daily-stock-suggest](https://github.com/phonlapatS/daily-stock-suggest)

