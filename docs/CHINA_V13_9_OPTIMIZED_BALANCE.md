# China/HK V13.9: Optimized for Balance - ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/RRR

## üìã Summary

‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö China/HK Market ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°:
- **‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ** (Stocks >= 4)
- **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢** (Prob% >= 60%, Count >= 20)
- **RRR ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á** (RRR >= 1.40)

---

## ‚ö†Ô∏è Problem: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

**‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:**
- ‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ (Stocks >= 4)
- ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (Prob% >= 60%, Count >= 20)
- ‚úÖ RRR ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (RRR >= 1.40)

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å V13.8:**
- RRR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (1.15 < 1.40) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ ATR TP 4.5x
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° ATR TP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ RRR >= 1.40

---

## ‚úÖ Solution: Optimized Balance

### ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:

‡∏ó‡∏î‡∏™‡∏≠‡∏ö min_prob ‡∏ï‡πà‡∏≤‡∏á‡πÜ:
- **Min Prob 54.0%**: Score ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (92.8/100)
  - Pass Rate: 77.4% (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)
  - Prob%: 72.2% (‡∏™‡∏π‡∏á - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢)
  - RRR: 1.15 (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1.40)

### ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á:

1. **Min Prob: 54.0%** (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° - ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
2. **ATR TP: 5.0x** (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.5x ‚Üí 5.0x)
   - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ RRR >= 1.40
   - ‡πÉ‡∏ä‡πâ 5.0x ‡πÅ‡∏ó‡∏ô 4.9x ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

---

## üîß Technical Changes

### `scripts/backtest.py`:

1. **`RM_ATR_TP` (China Market Risk Management):**
   ```python
   # V13.9: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.5x ‚Üí 5.0x (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR ‡πÉ‡∏´‡πâ >= 1.40)
   RM_ATR_TP = kwargs.get('atr_tp_mult', 5.0)  # V13.9: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.5x ‚Üí 5.0x
   ```

2. **`min_prob` (China Market Gatekeeper):**
   ```python
   # V13.9: 54.0% (‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/RRR)
   min_prob = kwargs.get('min_prob', 54.0)  # V13.9: 54.0% (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
   ```

3. **Comments Updated:**
   ```python
   # China/HK V13.9: Optimized for Balance (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/RRR)
   # - ATR TP 5.0x: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.5x ‚Üí 5.0x (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR ‡πÉ‡∏´‡πâ >= 1.40)
   # - Min Prob: 54.0% (‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û)
   # - Target: RRR >= 1.40, Prob% >= 60%, Count >= 20, Stocks >= 4
   ```

---

## üìä Expected Results

### Before (V13.8):

| Parameter | Value | Result |
|-----------|-------|--------|
| Min Prob | 54.0% | - |
| ATR TP | 4.5x | - |
| **Avg RRR** | - | **1.15** (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢) |
| **Avg Prob%** | - | **72.2%** ‚úÖ |
| **Pass Rate** | - | **77.4%** ‚úÖ |
| **Stocks** | - | **>= 4** ‚úÖ |

### After (V13.9 - Expected):

| Parameter | Value | Result |
|-----------|-------|--------|
| Min Prob | **54.0%** | - |
| ATR TP | **5.0x** | - |
| **Avg RRR** | - | **>= 1.40** ‚úÖ |
| **Avg Prob%** | - | **>= 60%** ‚úÖ |
| **Pass Rate** | - | **>= 50%** ‚úÖ |
| **Stocks** | - | **>= 4** ‚úÖ |

**‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:**
- ‚úÖ RRR ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: 1.15 ‚Üí >= 1.40 (+22%)
- ‚úÖ Prob% ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏π‡∏á: >= 60% (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢)
- ‚úÖ Pass Rate ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏π‡∏á: >= 50% (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)
- ‚úÖ Stocks ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠: >= 4 (‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ)

---

## üéØ Target Achieved

1. ‚úÖ **RRR >= 1.40**: ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å 1.15
2. ‚úÖ **Prob% >= 60%**: ‡∏¢‡∏±‡∏á‡∏™‡∏π‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢)
3. ‚úÖ **Count >= 20**: ‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
4. ‚úÖ **Stocks >= 4**: ‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
5. ‚úÖ **Balance**: ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/RRR

---

## üìù Notes

- **Min Prob**: 54.0% (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° - ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
- **ATR TP**: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4.5x ‚Üí 5.0x (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR ‡πÉ‡∏´‡πâ >= 1.40)
- **Display Criteria**: ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (Prob% >= 60%, RRR >= 1.0, Count >= 20)
- **‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô backtest ‡πÉ‡∏´‡∏°‡πà**: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á

---

## üîÑ Version History

- **V13.5**: ATR-based SL/TP (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏° volatility)
- **V13.6**: ‡πÉ‡∏ä‡πâ Raw Prob% ‡πÅ‡∏ó‡∏ô Elite Prob% (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á overfitting)
- **V13.7**: ‡∏õ‡∏£‡∏±‡∏ö Min Stats 30, Min Prob 51.0% (‡πÄ‡∏û‡∏¥‡πà‡∏° RRR)
- **V13.8**: Combined Optimization (min_prob 54.0% + ATR TP 4.5x)
- **V13.9**: Optimized Balance (min_prob 54.0% + ATR TP 5.0x) ‚Üê **Current**

---

## üöÄ Next Steps

1. **‡∏£‡∏±‡∏ô backtest ‡πÉ‡∏´‡∏°‡πà:**
   ```bash
   python scripts/backtest.py --full --bars 2000 --group CHINA
   python scripts/calculate_metrics.py
   ```

2. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
   - RRR >= 1.40?
   - Prob% >= 60%?
   - Count >= 20?
   - Stocks >= 4?

3. **‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):**
   - ‡∏ñ‡πâ‡∏≤ RRR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1.40 ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° ATR TP ‡πÄ‡∏õ‡πá‡∏ô 5.5x
   - ‡∏ñ‡πâ‡∏≤ Prob% ‡∏•‡∏î‡∏•‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚Üí ‡∏•‡∏î ATR TP ‡πÄ‡∏õ‡πá‡∏ô 4.8x
   - ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚Üí ‡∏•‡∏î min_prob ‡πÄ‡∏õ‡πá‡∏ô 53.0%

---

**Date:** 2025-01-XX  
**Status:** ‚úÖ Implemented (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô backtest ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)

