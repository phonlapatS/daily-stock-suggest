# System Cleanup & Engine Migration Log
**Date:** 2026-02-19  
**Version:** V7.0 — Logic Threshold Only Engines

---

## 1. Engine Migration

### Config Changes (`config.py`)
| Group | Old Engine | New Engine |
|-------|-----------|------------|
| GROUP_A_THAI | MEAN_REVERSION | **THAI_LOGIC_THRESHOLD_ONLY** |
| GROUP_B_US | TREND_MOMENTUM | **US_LOGIC_THRESHOLD_ONLY** |
| GROUP_C_CHINA_HK | MEAN_REVERSION | **CHINA_LOGIC_THRESHOLD_ONLY** |
| GROUP_D_TAIWAN | TREND_MOMENTUM | **TAIWAN_LOGIC_THRESHOLD_ONLY** |
| Gold/Silver | *(unchanged)* | *(unchanged)* |

### min_floor Bug Fix (Critical)
All `*_logic_threshold_only` engines had wrong units:

| Engine | Before (WRONG) | After (CORRECT) |
|--------|---------------|-----------------|
| Thai | 1.0 (=100%) | **0.01** (=1.0%) |
| US | 0.6 (=60%) | **0.006** (=0.6%) |
| China | 0.8 (=80%) | **0.008** (=0.8%) |
| HK | 0.7 (=70%) | **0.007** (=0.7%) |
| Taiwan | 0.9 (=90%) | **0.009** (=0.9%) |

---

## 2. Core Logic Updates

| File | Change |
|------|--------|
| `base_engine.py` | Added `get_active_pattern()` (Rule 2) + `select_best_fit()` (Rule 3) |
| `performance.py` | NEUTRAL N+1 = LOSS (Rule 4) |
| 5× `*_logic_threshold_only.py` | Anti-overlapping (1 result/stock) + list output format |
| `reversion_engine.py` | Refactored to use new core methods |
| `trend_engine.py` | Refactored to use new core methods |

---

## 3. Forward Testing Fresh Start

| Action | File | Detail |
|--------|------|--------|
| Backup | `logs/performance_log_backup_old_engine.csv` | Old engine forecasts preserved |
| Backup | `data/forecast_tomorrow_backup_old_engine.csv` | Old predictions preserved |
| Deleted | `logs/performance_log.csv` | Cleared for new engine results |
| Deleted | `data/forecast_tomorrow.csv` | Cleared for new engine results |

**Reason:** Old log data was generated by MEAN_REVERSION/TREND_MOMENTUM engines. New `*_LOGIC_THRESHOLD_ONLY` engines use fundamentally different pattern selection logic, so old forward testing results are not comparable.

---

## 4. Master Stats Script Update

**File:** `scripts/generate_master_stats.py`  
**Change:** Removed Chance/Prob columns — now counts pattern occurrences only.

**New columns:** `Symbol, Market, Threshold, Max_Streak_Pos, Max_Streak_Neg, Pattern, Pattern_Name, Category, Length, Count, Bars`

**Run:** `python scripts/generate_master_stats.py`  
**Output:** `data/Master_Pattern_Stats_NewLogic.csv`

---

## 5. Threshold Formula (All Markets)

```
Threshold = MAX( 20-day Rolling SD, 252-day Rolling SD, Market Floor )
```

- Layer 1: 20-day SD (short-term volatility)
- Layer 2: 252-day SD (≈1 year, yearly base)
- Layer 3: Market-specific absolute floor

เก็บเฉพาะวันที่ `|return| > threshold` → `+` หรือ `-` เท่านั้น  
วัน neutral → จุดตัด streak (ไม่นับ)
